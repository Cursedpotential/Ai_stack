# Salem Processing Stack - Coolify/Traefik Ready
# Domain: mitechconsult.com
# R2 Mount: /mnt/r2 (set up rclone on host)
# Deploy via Coolify UI > New Resource > Docker Compose

version: '3.8'

services:
  postgres:
    image: postgres:16-alpine
    container_name: salem-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: salem
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-salem_local_2024}
      POSTGRES_DB: salem_processing
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - /mnt/r2:/mnt/r2:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U salem -d salem_processing"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - default
    labels:
      - "traefik.enable=false"

  dragonfly:
    image: docker.dragonflydb.io/dragonflydb/dragonfly
    container_name: salem-dragonfly
    restart: unless-stopped
    ulimits:
      memlock: -1
    volumes:
      - dragonfly_data:/data
    networks:
      - default
    labels:
      - "traefik.enable=false"

  mongo:
    image: mongo:7
    container_name: salem-mongo
    restart: unless-stopped
    volumes:
      - mongo_data:/data/db
    networks:
      - default
    labels:
      - "traefik.enable=false"

  n8n:
    image: n8nio/n8n:latest
    container_name: salem-n8n
    restart: unless-stopped
    environment:
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=postgres
      - DB_POSTGRESDB_PORT=5432
      - DB_POSTGRESDB_DATABASE=n8n
      - DB_POSTGRESDB_USER=salem
      - DB_POSTGRESDB_PASSWORD=${POSTGRES_PASSWORD:-salem_local_2024}
      - N8N_HOST=0.0.0.0
      - N8N_PORT=5678
      - N8N_PROTOCOL=https
      - WEBHOOK_URL=https://n8n.mitechconsult.com
      - GENERIC_TIMEZONE=America/Detroit
      - TZ=America/Detroit
      - N8N_COMMUNITY_PACKAGES_ENABLED=true
      - QUEUE_BULL_REDIS_HOST=dragonfly
      - QUEUE_BULL_REDIS_PORT=6379
    volumes:
      - n8n_data:/home/node/.n8n
      - salem_files:/files
      - /mnt/r2:/mnt/r2
    depends_on:
      postgres:
        condition: service_healthy
      dragonfly:
        condition: service_started
    networks:
      - default
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.n8n.rule=Host(`n8n.mitechconsult.com`)"
      - "traefik.http.routers.n8n.entrypoints=https"
      - "traefik.http.routers.n8n.tls=true"
      - "traefik.http.routers.n8n.tls.certresolver=letsencrypt"
      - "traefik.http.services.n8n.loadbalancer.server.port=5678"
    expose:
      - "5678"

  unstructured:
    image: quay.io/unstructured-io/unstructured-api:latest
    container_name: salem-unstructured
    restart: unless-stopped
    volumes:
      - unstructured_data:/app/data
      - /mnt/r2:/mnt/r2
    networks:
      - default
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.unstructured.rule=Host(`unstructured.mitechconsult.com`)"
      - "traefik.http.routers.unstructured.entrypoints=https"
      - "traefik.http.routers.unstructured.tls=true"
      - "traefik.http.routers.unstructured.tls.certresolver=letsencrypt"
      - "traefik.http.services.unstructured.loadbalancer.server.port=8000"
    expose:
      - "8000"

  mem0:
    image: mem0ai/mem0:latest
    container_name: salem-mem0
    restart: unless-stopped
    environment:
      - POSTGRES_URL=postgresql://salem:${POSTGRES_PASSWORD:-salem_local_2024}@postgres:5432/mem0
    volumes:
      - mem0_data:/app/data
      - /mnt/r2:/mnt/r2:ro
    depends_on:
      - postgres
    networks:
      - default
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.mem0.rule=Host(`mem0.mitechconsult.com`)"
      - "traefik.http.routers.mem0.entrypoints=https"
      - "traefik.http.routers.mem0.tls=true"
      - "traefik.http.routers.mem0.tls.certresolver=letsencrypt"
      - "traefik.http.services.mem0.loadbalancer.server.port=8080"
    expose:
      - "8080"

  graphiti:
    image: getzep/graphiti:latest
    container_name: salem-graphiti
    restart: unless-stopped
    environment:
      - NEO4J_URI=${NEO4J_URI}
      - NEO4J_USER=${NEO4J_USER:-neo4j}
      - NEO4J_PASSWORD=${NEO4J_PASSWORD}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
    volumes:
      - graphiti_data:/app/data
      - /mnt/r2:/mnt/r2:ro
    networks:
      - default
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.graphiti.rule=Host(`graphiti.mitechconsult.com`)"
      - "traefik.http.routers.graphiti.entrypoints=https"
      - "traefik.http.routers.graphiti.tls=true"
      - "traefik.http.routers.graphiti.tls.certresolver=letsencrypt"
      - "traefik.http.services.graphiti.loadbalancer.server.port=8000"
    expose:
      - "8000"

  fastmcp:
    image: ghcr.io/jlowin/fastmcp:latest
    container_name: salem-fastmcp
    restart: unless-stopped
    volumes:
      - fastmcp_data:/app/data
      - /mnt/r2:/mnt/r2
    networks:
      - default
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.fastmcp.rule=Host(`mcp.mitechconsult.com`)"
      - "traefik.http.routers.fastmcp.entrypoints=https"
      - "traefik.http.routers.fastmcp.tls=true"
      - "traefik.http.routers.fastmcp.tls.certresolver=letsencrypt"
      - "traefik.http.services.fastmcp.loadbalancer.server.port=8000"
    expose:
      - "8000"

  lobechat:
    image: lobehub/lobe-chat:latest
    container_name: salem-lobechat
    restart: unless-stopped
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - OPENAI_PROXY_URL=${OPENAI_PROXY_URL:-}
      - ACCESS_CODE=${LOBECHAT_ACCESS_CODE:-}
    volumes:
      - lobechat_data:/app/data
    networks:
      - default
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.lobechat.rule=Host(`lobe.mitechconsult.com`)"
      - "traefik.http.routers.lobechat.entrypoints=https"
      - "traefik.http.routers.lobechat.tls=true"
      - "traefik.http.routers.lobechat.tls.certresolver=letsencrypt"
      - "traefik.http.services.lobechat.loadbalancer.server.port=3210"
    expose:
      - "3210"

  librechat:
    image: ghcr.io/danny-avila/librechat:latest
    container_name: salem-librechat
    restart: unless-stopped
    environment:
      - MONGO_URI=mongodb://mongo:27017/librechat
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
    volumes:
      - librechat_data:/app/data
      - /mnt/r2:/mnt/r2:ro
    depends_on:
      - mongo
    networks:
      - default
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.librechat.rule=Host(`libre.mitechconsult.com`)"
      - "traefik.http.routers.librechat.entrypoints=https"
      - "traefik.http.routers.librechat.tls=true"
      - "traefik.http.routers.librechat.tls.certresolver=letsencrypt"
      - "traefik.http.services.librechat.loadbalancer.server.port=3080"
    expose:
      - "3080"

  open-webui:
    image: ghcr.io/open-webui/open-webui:main
    container_name: salem-open-webui
    restart: unless-stopped
    environment:
      - OLLAMA_BASE_URL=${OLLAMA_BASE_URL:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - WEBUI_SECRET_KEY=${WEBUI_SECRET_KEY:-supersecretkey}
    volumes:
      - openwebui_data:/app/backend/data
      - /mnt/r2:/mnt/r2:ro
    networks:
      - default
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.openwebui.rule=Host(`chat.mitechconsult.com`)"
      - "traefik.http.routers.openwebui.entrypoints=https"
      - "traefik.http.routers.openwebui.tls=true"
      - "traefik.http.routers.openwebui.tls.certresolver=letsencrypt"
      - "traefik.http.services.openwebui.loadbalancer.server.port=8080"
    expose:
      - "8080"

volumes:
  postgres_data:
  dragonfly_data:
  mongo_data:
  n8n_data:
  salem_files:
  unstructured_data:
  mem0_data:
  graphiti_data:
  fastmcp_data:
  lobechat_data:
  librechat_data:
  openwebui_data:
